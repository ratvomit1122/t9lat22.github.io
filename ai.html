<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>T9 OS ‚Äî Reactive (Plain JS)</title>
<link rel="shortcut icon" href="favicon.png" />
<style>
  /* ---------- BASE / THEME ---------- */
  :root{
    --bg1: #0b0220;
    --bg2: #3a0057;
    --glass: rgba(255,255,255,0.06);
    --accent: #7c4dff;
    --ui: #111;
    --text: #fff;
    --muted: #bdbdbd;
    --shadow: 0 8px 30px rgba(2,2,8,0.6);
    --radius: 14px;
    --nav-h: 58px;
  }
  @media (prefers-reduced-motion: reduce){
    * { transition: none !important; animation: none !important; }
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }

  /* ---------- LAYOUT ---------- */
  .screen{
    position:relative;
    height:100vh;
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:14px;
    box-sizing:border-box;
  }

  /* Top bar (clock + small nav) */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .top-left { display:flex; gap:8px; align-items:center; }
  .brand { font-family: 'Luckiest Guy',sans-serif; font-size:20px; letter-spacing:1px; color:var(--text); }
  .clock { font-size:14px; color:var(--muted); min-width:90px; text-align:right; }

  /* central work area */
  .desktop{
    position:relative;
    flex:1 1 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  /* grid icons */
  .dock{
    position:fixed;
    bottom:14px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:10px;
    background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    padding:8px 12px;
    border-radius:999px;
    box-shadow:var(--shadow);
    z-index:100;
    align-items:center;
  }
  .dock button{ background:transparent;border:0;padding:6px 8px;border-radius:10px; cursor:pointer; display:flex; align-items:center; gap:8px; color:var(--text); }
  .dock img{ width:36px; height:36px; border-radius:10px; display:block; transition:transform .18s ease; }
  .dock button:hover img{ transform:translateY(-6px) scale(1.06); }

  /* windows */
  .win{
    position:absolute;
    min-width:260px;
    min-height:160px;
    max-width:96%;
    max-height:92%;
    width:min(1100px,86%);
    height:min(640px,84%);
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,0.04);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    transform-origin: left top;
    will-change: transform, opacity;
    transition: transform 220ms cubic-bezier(.2,.9,.25,1), opacity 160ms linear;
  }
  .win.hidden{ opacity:0; pointer-events:none; transform:scale(.98); }
  .win .top{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; gap:8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-bottom:1px solid rgba(255,255,255,0.02);
  }
  .win .title{ font-weight:600; color:var(--text); font-size:14px; }
  .win .controls{ display:flex; gap:8px; align-items:center; }
  .cbtn{ width:28px; height:28px; display:inline-grid; place-items:center; border-radius:6px; cursor:pointer; border:0; background:transparent; color:var(--muted); }
  .cbtn:hover{ background:rgba(255,255,255,0.02); color:var(--text); }
  .win .body{ flex:1 1 auto; position:relative; overflow:auto; -webkit-overflow-scrolling:touch; }

  /* small responsive tweaks */
  @media (max-width:860px){
    .win{ width:92%; height:78%; min-width:200px; min-height:120px; }
    .dock img{ width:30px; height:30px; }
  }

  /* search bar */
  .searchbar{
    position:fixed; top:70px; left:50%; transform:translateX(-50%);
    width:min(720px,92%); background:var(--glass); padding:10px 12px; border-radius:999px; box-shadow:0 6px 30px rgba(2,2,8,0.5); display:flex; gap:8px; align-items:center;
  }
  .searchbar input{ flex:1; border:0; background:transparent; color:var(--text); outline:none; font-size:15px; }
  .searchbar button{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; background:rgba(255,255,255,0.03); color:var(--text); }

  /* notifications */
  .notify-wrap{ position:fixed; top:18px; left:50%; transform:translateX(-50%); z-index:9999; display:flex; gap:8px; flex-direction:column; align-items:center; pointer-events:none; }
  .toast{ background:rgba(20,20,20,0.7); padding:10px 14px; border-radius:10px; color:var(--text); box-shadow:var(--shadow); pointer-events:auto; }

  /* small helper */
  .muted{ color:var(--muted); font-size:13px; }
  .grow{ flex:1; }

  /* draggable handle */
  .handle{ cursor:grab; display:flex; align-items:center; gap:8px; }
  .handle:active{ cursor:grabbing; }

  /* tiny loader */
  .loader{ width:20px; height:20px; border-radius:50%; border:3px solid rgba(255,255,255,0.08); border-top-color:var(--accent); animation:spin 800ms linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  /* subtle wallpaper example */
  .wallpaper{
    position:absolute; inset:0; background-image:url('abstract.png'); background-size:cover; background-position:center; opacity:0.08; filter:blur(2px) saturate(120%); pointer-events:none; z-index:0;
  }

  /* small mobile dock */
  .mobile-dock{
    display:none;
  }
  @media(max-width:520px){
    .topbar { padding:6px 0; }
    .dock{ bottom:10px; }
    .searchbar{ top:14px; }
    .mobile-dock{ display:flex; position:fixed; right:12px; top:12px; gap:8px; z-index:100; flex-direction:column; }
  }
</style>
</head>
<body>
  <div class="screen" id="screen" tabindex="0">
    <div class="topbar">
      <div class="top-left">
        <div class="brand">T9 OS</div>
        <div class="muted" id="version">v2.17</div>
      </div>
      <div class="grow"></div>
      <div class="clock" id="clock">--:--</div>
    </div>

    <div class="desktop" id="desktop" aria-live="polite">
      <div class="wallpaper" id="wallpaper" aria-hidden="true"></div>

      <!-- Example starter windows (hidden until opened) -->
      <div class="win hidden" id="win-browser" data-type="iframe" aria-hidden="true" style="left:calc(50% - 520px); top:80px;">
        <div class="top">
          <div class="handle" data-drag="win-browser"><span class="title">Browser</span></div>
          <div class="controls">
            <button class="cbtn" data-action="min" aria-label="Minimize">‚ñÅ</button>
            <button class="cbtn" data-action="close" aria-label="Close">‚úï</button>
          </div>
        </div>
        <div class="body" data-body="win-browser" id="body-browser">
          <!-- content will lazy load when opened -->
          <div class="muted" style="padding:20px">Open an app from the dock (lazy-load iframe)</div>
        </div>
      </div>

      <div class="win hidden" id="win-games" data-type="iframe" aria-hidden="true" style="left:calc(50% + 20px); top:120px;">
        <div class="top">
          <div class="handle" data-drag="win-games"><span class="title">Games</span></div>
          <div class="controls">
            <button class="cbtn" data-action="min" aria-label="Minimize">‚ñÅ</button>
            <button class="cbtn" data-action="close" aria-label="Close">‚úï</button>
          </div>
        </div>
        <div class="body" data-body="win-games">
          <div class="muted" style="padding:20px">Open to load games.</div>
        </div>
      </div>

      <!-- notifications container -->
      <div class="notify-wrap" id="notifications" aria-live="polite"></div>
    </div>

    <!-- dock (center) -->
    <div class="dock" role="toolbar" aria-label="Dock">
      <button data-open="win-browser" title="Open Browser">
        <img src="search.png" alt="Browser" />
      </button>
      <button data-open="win-games" title="Open Games">
        <img src="gameicon.png" alt="Games" />
      </button>
      <button id="open-chat" title="Chat">
        <img src="chat2.png" alt="Chat" />
      </button>
      <button id="open-settings" title="Settings">
        <img src="settings22.png" alt="Settings" />
      </button>
    </div>

    <!-- small mobile quick buttons -->
    <div class="mobile-dock" aria-hidden="true">
      <button id="m-open-search" title="Search">üîé</button>
    </div>

    <!-- search bar -->
    <div class="searchbar" id="searchbar" role="search" aria-hidden="false">
      <input id="searchInput" placeholder="Search the web or open app..." aria-label="Search"/>
      <button id="searchBtn">Go</button>
    </div>

    <!-- hidden chat window template: lazy-loads iframe -->
    <template id="iframeTpl">
      <iframe src="" loading="lazy" style="width:100%;height:100%;border:0"></iframe>
    </template>

  </div>

<script>
/* =========================
   Utilities: throttle/debounce
   ========================= */
const throttle = (fn, wait=50) => {
  let last = 0;
  return (...args) => {
    const now = Date.now();
    if (now - last >= wait) {
      last = now;
      fn(...args);
    }
  };
};
const debounce = (fn, wait=200) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), wait);
  };
};

/* =========================
   Tiny DOM helpers
   ========================= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const screen = $('#screen');
const notifWrap = $('#notifications');
const clockEl = $('#clock');
const wallpaper = $('#wallpaper');
const searchInput = $('#searchInput');

/* =========================
   Time + Clock (efficient)
   ========================= */
(function startClock(){
  const update = () => {
    const d = new Date();
    const h = d.getHours();
    const m = String(d.getMinutes()).padStart(2,'0');
    clockEl.textContent = `${h % 12 === 0 ? 12 : h % 12}:${m} ${h<12?'AM':'PM'}`;
  };
  update();
  setInterval(update, 30_000); // every 30s (no need for every second)
})();

/* =========================
   Simple notification
   ========================= */
function notify(text, time=4000){
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = text;
  notifWrap.appendChild(t);
  // auto remove
  setTimeout(()=> {
    t.style.opacity = '0';
    setTimeout(()=> t.remove(), 250);
  }, time);
}

/* =========================
   Window management (light)
   - open/close/minimize
   - lazy load iframe only when opened
   ========================= */
const openStack = []; // z-order stack
function zIndexFor(id){
  // bring to front
  openStack.splice(openStack.indexOf(id),1);
  openStack.push(id);
  // set z's
  openStack.forEach((winId, i) => {
    const w = document.getElementById(winId);
    if (w) w.style.zIndex = 100 + (i+1);
  });
}

function openWindow(winId, opts={}){
  const win = document.getElementById(winId);
  if (!win) return;
  win.classList.remove('hidden');
  win.removeAttribute('aria-hidden');
  // bring to front
  if (!openStack.includes(winId)) openStack.push(winId);
  zIndexFor(winId);
  // animate in
  win.style.transform = 'translateY(6px) scale(1)';
  win.style.opacity = '1';
  // lazy-load iframe/content
  const body = win.querySelector('[data-body]');
  if (win.dataset.type === 'iframe' && !body.dataset.loaded) {
    body.dataset.loaded = '1';
    lazyLoadIframe(body, opts.src || defaultSrcFor(winId));
  }
}

function defaultSrcFor(winId){
  if (winId === 'win-browser') return 'https://example.com';
  if (winId === 'win-games') return 'test99.html';
  return '';
}

function closeWindow(winId){
  const win = document.getElementById(winId);
  if (!win) return;
  win.classList.add('hidden');
  win.setAttribute('aria-hidden','true');
  // clean up iframe to free memory (optional)
  const body = win.querySelector('[data-body]');
  if (body && body.firstElementChild && body.firstElementChild.tagName === 'IFRAME') {
    // preserve src to reuse later if you prefer; here we remove to free memory
    body.removeChild(body.firstElementChild);
    delete body.dataset.loaded;
  }
  // remove from stack
  const idx = openStack.indexOf(winId);
  if (idx > -1) openStack.splice(idx,1);
  // update z-indexes
  zIndexFor(openStack[openStack.length-1] || openStack[0] || '');
}

/* =========================
   Lazy iframe loader
   ========================= */
const tpl = document.getElementById('iframeTpl');
function lazyLoadIframe(container, src){
  // small skeleton while loading
  container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%"><div class="loader" aria-hidden="true"></div></div>';
  // create iframe (defer src for a tick so loader shows)
  requestAnimationFrame(()=>{
    const frag = tpl.content.cloneNode(true);
    const iframe = frag.querySelector('iframe');
    iframe.src = src;
    iframe.setAttribute('allow', 'camera; microphone; geolocation; display-capture; autoplay');
    // once loaded, replace loader
    iframe.addEventListener('load', () => {
      container.innerHTML = '';
      container.appendChild(iframe);
    }, { once:true });
    // append after small delay (better UX)
    setTimeout(()=> {
      container.innerHTML = '';
      container.appendChild(iframe);
    }, 600);
  });
}

/* =========================
   Event delegation for dock buttons and window controls
   ========================= */
document.addEventListener('click', (ev) => {
  const openId = ev.target.closest('[data-open]')?.dataset?.open;
  if (openId) { openWindow(openId); return; }

  const actionBtn = ev.target.closest('.cbtn');
  if (actionBtn) {
    const win = actionBtn.closest('.win');
    if (!win) return;
    const action = actionBtn.dataset.action;
    const id = win.id;
    if (action === 'close') closeWindow(id);
    if (action === 'min') {
      win.style.transform = 'translateY(18px) scale(.98)';
      win.style.opacity = '0';
      setTimeout(()=> win.classList.add('hidden'), 200);
      // keep in stack to restore z-order
    }
    return;
  }
});

/* =========================
   Dragging (pointer events)
   - works with mouse/touch/stylus
   - uses transform for GPU accelerate
   - keeps positions in dataset to persist if needed
   ========================= */
let dragState = null;
const DRAG_TRESHOLD = 4;

function onPointerDown(e){
  const handle = e.target.closest('.handle');
  if(!handle) return;
  const winId = handle.closest('.win')?.id;
  if(!winId) return;
  e.preventDefault();
  const win = document.getElementById(winId);
  zIndexFor(winId);
  // read current transform if present
  const rect = win.getBoundingClientRect();
  const start = { x: rect.left, y: rect.top };
  const pointerStart = { x: e.clientX, y: e.clientY };
  // disable native drag image
  if (e.pointerType === 'mouse') (e.target).setPointerCapture?.(e.pointerId);

  dragState = { win, start, pointerStart, id: winId, dragging:false };
  window.addEventListener('pointermove', onPointerMove);
  window.addEventListener('pointerup', onPointerUp, { once:true });
}

function onPointerMove(e){
  if(!dragState) return;
  const d = dragState;
  const dx = e.clientX - d.pointerStart.x;
  const dy = e.clientY - d.pointerStart.y;
  if(!d.dragging && Math.hypot(dx,dy) > DRAG_TRESHOLD) d.dragging = true;
  if(d.dragging){
    // use translate for smooth GPU animations
    d.win.style.left = `${d.start.x + dx}px`;
    d.win.style.top = `${d.start.y + dy}px`;
  }
}

function onPointerUp(e){
  if(!dragState) return;
  // commit final position
  // optionally store in localStorage: position persistence
  dragState = null;
  window.removeEventListener('pointermove', onPointerMove);
  // release pointer capture
}

/* attach pointerdown on document */
document.addEventListener('pointerdown', onPointerDown);

/* =========================
   Keyboard shortcuts (simple)
   ========================= */
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
    // focus search
    searchInput.focus();
    e.preventDefault();
  }
  if (e.key === 'Escape') {
    // close top-most window
    const top = openStack[openStack.length-1];
    if (top) closeWindow(top);
  }
});

/* =========================
   Search handler (open browser or run quick actions)
   ========================= */
$('#searchBtn').addEventListener('click', () => doSearch(searchInput.value));
searchInput.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') doSearch(searchInput.value); });

function doSearch(q){
  q = (q||'').trim();
  if (!q) { notify('Type something to search.'); return; }
  // quick app opens
  const lower = q.toLowerCase();
  if (lower === 'games' || lower === 'open games') { openWindow('win-games'); notify('Opening Games'); return; }
  if (lower === 'browser' || lower === 'open browser') { openWindow('win-browser'); notify('Opening Browser'); return; }
  // otherwise open browser and navigate to search
  openWindow('win-browser', { src: 'https://www.google.com/search?q=' + encodeURIComponent(q) });
  notify('Searching: ' + q);
}

/* =========================
   Resize handling: reposition windows if offscreen
   ========================= */
const safeReposition = () => {
  document.querySelectorAll('.win').forEach(w => {
    if (w.classList.contains('hidden')) return;
    const r = w.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;
    let changed = false;
    let left = parseFloat(w.style.left || r.left);
    let top = parseFloat(w.style.top || r.top);
    if (left + r.width > vw - 8) { left = Math.max(8, vw - r.width - 8); changed = true; }
    if (top + r.height > vh - 8) { top = Math.max(8, vh - r.height - 8); changed = true; }
    if (left < 8) { left = 8; changed = true; }
    if (top < 48) { top = 48; changed = true; }
    if (changed) { w.style.left = left + 'px'; w.style.top = top + 'px'; }
  });
};
window.addEventListener('resize', debounce(safeReposition, 220));

/* =========================
   Sticky lazy wallpaper switching (localStorage)
   ========================= */
(function initWallpaper(){
  const stored = localStorage.getItem('t9_wallpaper');
  if (stored) wallpaper.style.backgroundImage = `url("${stored}")`;
  else wallpaper.style.backgroundImage = `url('abstract.png')`;
})();
function setWallpaper(url){ wallpaper.style.backgroundImage = `url("${url}")`; localStorage.setItem('t9_wallpaper', url); }

/* =========================
   Quick open settings / chat (example: simple modal)
   ========================= */
document.getElementById('open-chat').addEventListener('click', ()=> {
  openWindow('win-browser', { src: 'chat.html' }); // reusing browser window for demo
});
document.getElementById('open-settings').addEventListener('click', ()=> {
  // create a small settings window dynamically if not exists
  let id = 'win-settings';
  if (!document.getElementById(id)) {
    const node = document.createElement('div');
    node.className = 'win';
    node.id = id;
    node.style.left = '30px';
    node.style.top = '120px';
    node.innerHTML = `
      <div class="top"><div class="handle" data-drag="${id}"><span class="title">Settings</span></div>
      <div class="controls"><button class="cbtn" data-action="close">‚úï</button></div></div>
      <div class="body" data-body="${id}" style="padding:14px">
        <div style="display:flex;flex-direction:column;gap:10px">
          <label class="muted">Wallpaper URL</label>
          <input id="wall-url" placeholder="image url or leave default" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
          <div style="display:flex;gap:8px">
            <button id="save-wall" style="padding:8px;border-radius:8px;border:0;cursor:pointer">Save</button>
            <button id="reset-wall" style="padding:8px;border-radius:8px;border:0;cursor:pointer">Reset</button>
          </div>
        </div>
      </div>`;
    document.getElementById('desktop').appendChild(node);
    document.querySelector('#save-wall').addEventListener('click', () => {
      const v = document.getElementById('wall-url').value.trim();
      if (v) { setWallpaper(v); notify('Wallpaper changed'); } else notify('Enter a URL first');
    });
    document.querySelector('#reset-wall').addEventListener('click', () => {
      localStorage.removeItem('t9_wallpaper'); setWallpaper('abstract.png'); notify('Wallpaper reset');
    });
  }
  openWindow(id);
});

/* =========================
   Small UX: auto-open a tutorial toast on first visit
   ========================= */
if (!localStorage.getItem('t9_seen_intro')) {
  notify('Welcome to T9 OS ‚Äî press Ctrl/Cmd+K to search. Tap dock icons to open apps.');
  localStorage.setItem('t9_seen_intro', '1');
}

/* =========================
   Simple persistence for open window positions (optional)
   ========================= */
window.addEventListener('beforeunload', () => {
  const state = {};
  document.querySelectorAll('.win').forEach(w => {
    const rect = w.getBoundingClientRect();
    state[w.id] = { left: rect.left, top: rect.top, hidden: w.classList.contains('hidden') };
  });
  localStorage.setItem('t9_win_state', JSON.stringify(state));
});
(function restoreState(){
  try {
    const raw = localStorage.getItem('t9_win_state');
    if (!raw) return;
    const state = JSON.parse(raw);
    Object.keys(state).forEach(id => {
      const w = document.getElementById(id);
      if (!w) return;
      const s = state[id];
      w.style.left = s.left + 'px';
      w.style.top = s.top + 'px';
      if (!s.hidden) openWindow(id);
    });
  } catch(e){}
})();

/* =========================
   Accessibility: focus management for windows
   ========================= */
document.addEventListener('focusin', (ev) => {
  const win = ev.target.closest('.win');
  if (win) zIndexFor(win.id);
});

/* =========================
   Init: pre-position some windows for nicer first-open feel
   ========================= */
(function initPositions(){
  const b = document.getElementById('win-browser');
  const g = document.getElementById('win-games');
  if (b){ b.style.left = (window.innerWidth/2 - 560) + 'px'; b.style.top = '72px'; }
  if (g){ g.style.left = (window.innerWidth/2 + 20) + 'px'; g.style.top = '120px'; }
})();

/* =========================
   Performance note:
   - animations use transform/opacity
   - large DOM updates avoided
   - lazy-loading for iframes/images
   ========================= */

</script>
</body>
</html>
